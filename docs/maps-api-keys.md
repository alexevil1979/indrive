# Получение API ключей для карт

Инструкции по получению API ключей для Google Maps и Яндекс Карт.

---

## Google Maps API

### 1. Создание проекта в Google Cloud

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Войдите в аккаунт Google
3. Нажмите **Select a project** → **New Project**
4. Введите название проекта (например, `indrive-maps`)
5. Нажмите **Create**

### 2. Включение API

1. В меню слева выберите **APIs & Services** → **Library**
2. Найдите и включите следующие API:
   - **
   ** — для Android приложения
   - **Maps SDK for iOS** — для iOS приложения
   - **Maps JavaScript API** — для веб-версии (опционально)
   - **Geocoding API** — для преобразования адресов в координаты
   - **Directions API** — для построения маршрутов
   - **Places API** — для поиска мест и автодополнения адресов

Для каждого API:
1. Найдите API в библиотеке
2. Нажмите на него
3. Нажмите **Enable**

### 3. Создание API ключа

1. Перейдите в **APIs & Services** → **Credentials**
2. Нажмите **+ Create Credentials** → **API Key**
3. Скопируйте созданный ключ

### 4. Ограничение API ключа (рекомендуется)

1. Нажмите на созданный ключ для редактирования

2. В разделе **Application restrictions**:

#### Для Android:

Выберите **Android apps** → **Add** и заполните:

**Package name** (имя пакета) — берётся из `app.json`:
```
Приложение пассажира:  com.ridehail.passenger
Приложение водителя:   com.ridehail.driver
```

**SHA-1 отпечаток** — зависит от типа сборки:

**Вариант A: Debug (для разработки)**

На компьютере с проектом выполните:

Windows:
```cmd
keytool -list -v -keystore "%USERPROFILE%\.android\debug.keystore" -alias androiddebugkey -storepass android -keypass android
```

Linux/Mac:
```bash
keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android -keypass android
```

Найдите строку `SHA1:` — это и есть нужный отпечаток. Пример:
```
SHA1: DA:39:A3:EE:5E:6B:4B:0D:32:55:BF:EF:95:60:18:90:AF:D8:07:09
```

> Если файл `debug.keystore` не существует, сначала сделайте хотя бы один Android-билд.

**Вариант B: EAS Build (Expo Application Services)**

Если вы собираете через EAS:
```bash
# Для приложения пассажира
cd apps/mobile-passenger
eas credentials -p android

# Для приложения водителя
cd apps/mobile-driver
eas credentials -p android
```

Выберите **Keystore** → команда покажет SHA-1.

**Вариант C: Свой Release keystore**

Если у вас свой keystore для подписи релизных сборок:
```bash
keytool -list -v -keystore /path/to/your-release.keystore -alias your-alias
```

Введите пароль от keystore — найдите строку `SHA1:`.

**Вариант D: Создать новый keystore для релиза**

```bash
keytool -genkey -v -keystore indrive-release.keystore -alias indrive -keyalg RSA -keysize 2048 -validity 10000
```

Затем получите SHA-1 из нового keystore:
```bash
keytool -list -v -keystore indrive-release.keystore -alias indrive
```

> **Важно:** Сохраните keystore и пароли в безопасном месте! Потеря keystore = невозможность обновлять приложение в Google Play.

**Добавление в Google Cloud Console:**

Для каждого приложения добавьте две записи (debug + release):

| Package name | SHA-1 | Назначение |
|---|---|---|
| `com.ridehail.passenger` | `DA:39:...` (debug) | Тестирование |
| `com.ridehail.passenger` | `AB:CD:...` (release) | Продакшен |
| `com.ridehail.driver` | `DA:39:...` (debug) | Тестирование |
| `com.ridehail.driver` | `AB:CD:...` (release) | Продакшен |

#### Для iOS:

Выберите **iOS apps** → **Add** и введите bundle identifier:
```
Приложение пассажира:  com.ridehail.passenger
Приложение водителя:   com.ridehail.driver
```

Bundle identifier берётся из `app.json` → `expo.ios.bundleIdentifier`.

#### Для сервера (необязательно):

Если карты используются на сервере (геокодирование):
- Выберите **IP addresses**
- Укажите IP: `192.168.1.121` (или внешний IP вашего сервера)

3. В разделе **API restrictions**:
   - Выберите **Restrict key**
   - Отметьте только нужные API (Maps SDK for Android/iOS, Geocoding, Directions, Places)

4. Нажмите **Save**

### 5. Настройка биллинга

Google Maps API требует привязку платёжного метода:

1. Перейдите в **Billing** в Google Cloud Console
2. Нажмите **Link a billing account**
3. Создайте новый или выберите существующий billing account
4. Привяжите карту

**Важно:** Google предоставляет бесплатный лимит $200/месяц, что обычно покрывает:
- ~28,000 загрузок карты
- ~40,000 запросов геокодирования
- ~40,000 запросов маршрутов

### 6. Мониторинг использования

1. **APIs & Services** → **Dashboard**
2. Выберите нужный API
3. Смотрите графики запросов и ошибок

### Формат ключа Google

```
AIzaSyB1234567890abcdefghijklmnopqrstuvwx
```

Ключ начинается с `AIza` и содержит ~39 символов.

---

## Яндекс Карты API

### 1. Регистрация в Яндекс Developer

1. Перейдите в [Кабинет разработчика Яндекс](https://developer.tech.yandex.ru/)
2. Войдите через Яндекс ID (или создайте аккаунт)
3. Примите условия использования

### 2. Подключение API Карт

1. В кабинете разработчика нажмите **Подключить API**
2. Выберите **JavaScript API и HTTP Геокодер**
3. Или создайте новый ключ через **Ключи** → **Получить ключ**

### 3. Создание ключа

1. Перейдите в раздел **Ключи**
2. Нажмите **Получить ключ**
3. Заполните форму:
   - **Название сервиса** — например, `indrive`
   - **Ссылка на сервис** — URL вашего сайта или `*` для тестирования
   - **Выберите API**:
     - ✅ JavaScript API
     - ✅ HTTP Геокодер
     - ✅ Static API (для статичных карт)
     - ✅ Поиск по организациям
4. Нажмите **Получить ключ**

### 4. Типы ключей Яндекс

| API | Описание | Лимиты (бесплатно) |
|-----|----------|-------------------|
| JavaScript API | Интерактивные карты | 25,000 запросов/сутки |
| HTTP Геокодер | Адрес ↔ Координаты | 25,000 запросов/сутки |
| Static API | Статичные изображения карт | 25,000 запросов/сутки |
| Поиск по организациям | Поиск компаний на карте | 500 запросов/сутки |
| Маршрутизация | Построение маршрутов | По тарифу |

### 5. Ограничение по HTTP Referer

Для безопасности ограничьте использование ключа:

1. В настройках ключа найдите **Ограничение по HTTP Referer**
2. Добавьте разрешённые домены:
   ```
   https://indrive.1tlt.ru/*
   http://localhost:*
   ```

### 6. Коммерческое использование

Для коммерческих проектов требуется:
1. Заключить договор с Яндекс
2. Перейти на коммерческую версию API
3. Связаться: [Яндекс для бизнеса](https://yandex.ru/dev/commercial/)

**Бесплатная версия подходит для:**
- Тестирования и разработки
- Некоммерческих проектов
- Проектов с небольшой нагрузкой

### Формат ключа Яндекс

```
a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

Ключ в формате UUID (36 символов с дефисами).

---

## Настройка в indrive

### 1. Через Web Admin

1. Откройте админку: `https://indrive.1tlt.ru/settings` или `http://192.168.1.121:9010/settings`
2. Выберите провайдер карт (Google или Яндекс)
3. Введите соответствующий API ключ
4. Нажмите **Сохранить настройки**

### 2. Проверка работы

После сохранения настроек:
1. Перезапустите мобильное приложение
2. Карта должна загрузиться с выбранным провайдером

### 3. Переключение провайдера

Можно переключать провайдера в любой момент:
1. Измените выбор в настройках админки
2. Сохраните
3. Пользователям нужно перезапустить приложение

---

## Сравнение провайдеров

| Критерий | Google Maps | Яндекс Карты |
|----------|-------------|--------------|
| Покрытие мира | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| Покрытие России | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Покрытие СНГ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| Пробки | ✅ | ✅ (лучше для РФ) |
| Панорамы | ✅ Street View | ✅ Панорамы |
| Цена | $200/мес бесплатно | 25K запросов/сутки бесплатно |
| Оплата | Карта (включая РФ карты через обходные пути) | Рубли, российские карты |
| Документация | Английский | Русский |
| Поддержка | Английский | Русский |

### Рекомендации

- **Для России и СНГ** — Яндекс Карты (лучше покрытие, пробки, проще оплата)
- **Для международных проектов** — Google Maps (глобальное покрытие)
- **Для тестирования** — Яндекс (проще получить ключ, не нужна карта)

---

## Безопасность

### Не делайте так:
- ❌ Не храните ключи в коде приложения напрямую
- ❌ Не коммитьте ключи в Git
- ❌ Не используйте один ключ для всех сред (dev/staging/prod)

### Рекомендации:
- ✅ Храните ключи в переменных окружения или в базе данных
- ✅ Используйте разные ключи для разных сред
- ✅ Ограничивайте ключи по IP/домену/приложению
- ✅ Мониторьте использование ключей
- ✅ Ротируйте ключи периодически

---

## Troubleshooting

### Google Maps не загружается

1. Проверьте что ключ скопирован без пробелов
2. Убедитесь что включены нужные API в Google Cloud
3. Проверьте что привязан billing account
4. Посмотрите ошибки в консоли браузера / логах приложения

### Яндекс Карты не загружается

1. Проверьте что ключ скопирован без пробелов
2. Проверьте ограничения по HTTP Referer
3. Убедитесь что не превышен лимит запросов
4. Посмотрите ошибки в консоли

### Общие проблемы

- **Карта серая / не загружается** — проблема с ключом или сетью
- **Ошибка "API key not valid"** — неверный ключ или ограничения
- **Ошибка "Over query limit"** — превышен лимит запросов
